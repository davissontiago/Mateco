{% extends 'base.html' %}

{% block title %}PDV - Frente de Caixa{% endblock %}

{% block head %}
    <style>
        .caixa { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; width: 350px; }
        h1 { color: #333; font-size: 1.5rem; margin-bottom: 5px; }
        
        .campo-valor { margin: 20px 0; text-align: left; }
        label { display: block; font-weight: bold; color: #555; margin-bottom: 5px; }
        input[type="number"] { width: 100%; padding: 10px; font-size: 1.5em; text-align: center; border: 2px solid #ddd; border-radius: 5px; box-sizing: border-box; color: #2c3e50; font-weight: bold; }
        input:focus { border-color: #3498db; outline: none; }

        button { background-color: #3498db; color: white; border: none; padding: 15px 30px; font-size: 1.2em; border-radius: 5px; cursor: pointer; transition: 0.3s; width: 100%; margin-top: 10px;}
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        #status { margin-top: 20px; font-size: 0.9em; color: #666; min-height: 20px; word-wrap: break-word; }
        .sucesso { color: green !important; font-weight: bold; }
        .erro { color: red !important; font-weight: bold; }
        
        .loader { display: none; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
{% endblock %}

{% block content %}
    <div class="caixa">
        <h1>Frente de Caixa</h1>
        
        <div class="campo-valor">
            <label for="valorInput">Valor da Venda (R$):</label>
            <input type="number" id="valorInput" value="100.00" step="0.01" min="1">
        </div>
        
        <button id="btnEmitir" onclick="emitirNota()">
            <span id="btnTexto">EMITIR NFC-e</span>
            <div id="loader" class="loader"></div>
        </button>

        <div id="status">Pronto para emitir.</div>
    </div>

    {% csrf_token %}
{% endblock %}

{% block scripts %}
    <script>
        async function emitirNota() {
            const btn = document.getElementById('btnEmitir');
            const btnTexto = document.getElementById('btnTexto');
            const loader = document.getElementById('loader');
            const statusDiv = document.getElementById('status');
            
            const inputElement = document.getElementById('valorInput');
            let valorVenda = parseFloat(inputElement.value);

            if (isNaN(valorVenda) || valorVenda <= 0) {
                alert("Por favor, digite um valor válido!");
                return;
            }

            btn.disabled = true;
            btnTexto.style.display = 'none';
            loader.style.display = 'block';
            statusDiv.innerHTML = "Processando venda de R$ " + valorVenda.toFixed(2) + "...";
            statusDiv.className = "";

            try {
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                const response = await fetch('/emitir-nota/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ valor: valorVenda })
                });

                const data = await response.json();

                if (response.ok) {
                    const linkPdf = `/imprimir-nota/${data.id_nota}/`;
                    statusDiv.innerHTML = `
                        ✅ Nota de R$ ${data.valor ? parseFloat(data.valor).toFixed(2) : valorVenda} autorizada!<br>
                        <a href="${linkPdf}" target="_blank" style="color: blue; text-decoration: underline; font-weight: bold; font-size: 1.1em;">
                            [ IMPRIMIR CUPOM ]
                        </a>`;
                    statusDiv.className = "sucesso";
                } else {
                    throw new Error(data.mensagem || "Erro desconhecido");
                }

            } catch (error) {
                console.error(error);
                statusDiv.innerHTML = `❌ Erro: ${error.message}`;
                statusDiv.className = "erro";
            } finally {
                btn.disabled = false;
                btnTexto.style.display = 'inline';
                loader.style.display = 'none';
            }
        }
    </script>
{% endblock %}