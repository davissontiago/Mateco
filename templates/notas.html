{% extends 'base.html' %}

{% block title %}Hist√≥rico de Notas - Mateco{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    /* Previne rolagem horizontal na p√°gina inteira */
    body { overflow-x: hidden; }

    .container-notas { 
        max-width: 1000px; 
        margin: 0 auto; 
        padding-bottom: 50px;
        width: 100%; /* Garante que n√£o estoure */
        box-sizing: border-box;
    }

    h1 { color: {{ empresa_ativa.cor_primaria|default:'#00838f' }}; text-align: center; margin-bottom: 30px; }

    /* --- FILTROS --- */
    .filtros-container {
        background: white; padding: 20px; border-radius: 10px;
        margin-bottom: 25px; border: 1px solid #eee;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .form-filtros { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
    .filtro-item { flex: 1; min-width: 150px; }
    .filtro-item label { display: block; font-size: 0.8em; font-weight: bold; margin-bottom: 5px; color: #555; }
    .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; height: 40px; }

    /* --- BARRA DE TOTAIS (CSS BASE) --- */
    .resumo-bar {
        display: flex;
        justify-content: space-between;
        gap: 15px;
        margin-bottom: 25px;
        flex-wrap: wrap;
    }

    .resumo-item {
        flex: 1;
        min-width: 120px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #eee;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: center;
    }

    .resumo-item span { font-size: 0.7em; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; opacity: 0.7; }
    .resumo-item strong { font-size: 1.1em; color: #333; }

    /* Cores */
    .resumo-item.dinheiro { border-left: 5px solid #2e7d32; background-color: #f1f8e9; }
    .resumo-item.dinheiro strong { color: #2e7d32; }

    .resumo-item.pix { border-left: 5px solid #1565c0; background-color: #e3f2fd; }
    .resumo-item.pix strong { color: #1565c0; }

    .resumo-item.debito { border-left: 5px solid #f9a825; background-color: #fffde7; }
    .resumo-item.debito strong { color: #f9a825; }

    .resumo-item.credito { border-left: 5px solid #c62828; background-color: #ffebee; }
    .resumo-item.credito strong { color: #c62828; }

    .resumo-item.total { border-left: 5px solid #333; background-color: #eeeeee; }
    
    /* --- SELECT2 FIX --- */
    .select2-container { width: 100% !important; }
    .select2-selection--multiple { 
        min-height: 40px; border: 1px solid #ccc; border-radius: 5px; 
        display: flex; flex-wrap: wrap; padding: 2px;
    }
    .select2-selection__choice { 
        background-color: {{ empresa_ativa.cor_primaria|default:'#00838f' }} !important; 
        color: white !important; border: none !important; font-size: 0.85em; 
        margin: 2px !important; max-width: 90%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .select2-selection__choice__remove { color: white !important; margin-right: 5px !important; }

    /* --- TABELA PC --- */
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
    th { background-color: {{ empresa_ativa.cor_primaria|default:'#00838f' }}; color: white; font-weight: bold; text-transform: uppercase; font-size: 0.85em; }
    tr:hover { background-color: #f8f9fa; }

    .btn-ver { background-color: {{ empresa_ativa.cor_secundaria|default:'#546e7a' }}; color: white !important; padding: 10px 15px; text-decoration: none; border-radius: 5px; font-size: 0.9em; font-weight: bold; border: none; cursor: pointer; display: inline-block; transition: background 0.3s; width: auto; }
    .btn-ver:hover { background-color: #455a64; }
    .btn-limpar { background-color: #9e9e9e; }
    
    .status { padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; text-transform: uppercase; background-color: #d4edda; color: #155724; }
    .status.cancelada { background-color: #f8d7da; color: #721c24; }
    .empty-state { text-align: center; padding: 40px; color: #7f8c8d; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

    /* --- MOBILE OTIMIZADO --- */
    @media (max-width: 768px) {
        .form-filtros { flex-direction: column; align-items: stretch; }
        .filtro-item { width: 100%; min-width: 100%; margin-bottom: 10px; }
        .filtros-botoes { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .btn-ver { width: 100%; text-align: center; box-sizing: border-box; }

        /* --- GRADE DE TOTAIS NO MOBILE (CORRE√á√ÉO DO DESIGN) --- */
        .resumo-bar {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 colunas iguais */
            gap: 10px;
            overflow: visible; /* Remove scroll */
        }
        .resumo-item {
            min-width: 0; /* Permite encolher se precisar */
            margin: 0;
            padding: 10px;
        }
        .resumo-item strong {
            font-size: 1em; /* Fonte um pouco menor para caber */
        }
        /* O Total Geral ocupa a linha inteira em baixo */
        .resumo-item.total {
            grid-column: 1 / -1; 
            text-align: center;
            align-items: center;
            background-color: #333;
            color: white;
            border-left: none;
        }
        .resumo-item.total strong { color: white; font-size: 1.3em; }
        .resumo-item.total span { color: #ccc; }

        /* Tabela em Cards */
        thead { display: none; }
        table, tbody, th, td, tr { display: block; }
        tr { margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        td { padding: 12px 15px; text-align: right; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        td::before { content: attr(data-label); font-weight: bold; color: #555; text-transform: uppercase; font-size: 0.75em; }
        td:last-child { border-bottom: none; justify-content: center; padding-top: 15px; }
        td:last-child::before { display: none; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-notas">
    <h1>Hist√≥rico de Emiss√µes</h1>

    <div class="filtros-container">
        <form method="GET" class="form-filtros">
            
            <div style="display: flex; gap: 10px; width: 100%; flex-wrap: wrap;">
                <div class="filtro-item" style="flex: 1; min-width: 130px;">
                    <label>De:</label>
                    <input type="date" name="data_inicio" value="{{ filtros.data_inicio }}" class="form-control">
                </div>

                <div class="filtro-item" style="flex: 1; min-width: 130px;">
                    <label>At√©:</label>
                    <input type="date" name="data_fim" value="{{ filtros.data_fim }}" class="form-control">
                </div>
            </div>

            <div class="filtro-item">
                <label>Clientes:</label>
                <select name="clientes" class="form-control select2-cliente" multiple="multiple">
                    {% for cliente in todos_clientes %}
                        <option value="{{ cliente.id }}" {% if cliente.id in filtros.clientes %}selected{% endif %}>
                            {{ cliente.apelido|default:cliente.nome|truncatechars:25 }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filtro-item">
                <label>Forma Pgto:</label>
                <select name="pagamento" class="form-control select2-pagamento" multiple="multiple">
                    <option value="01" {% if '01' in filtros.pagamento %}selected{% endif %}>Dinheiro</option>
                    <option value="17" {% if '17' in filtros.pagamento %}selected{% endif %}>PIX</option>
                    <option value="04" {% if '04' in filtros.pagamento %}selected{% endif %}>D√©bito</option>
                    <option value="03" {% if '03' in filtros.pagamento %}selected{% endif %}>Cr√©dito</option>
                </select>
            </div>

            <div class="filtros-botoes">
                <button type="submit" class="btn-ver">Filtrar</button>
                <a href="{% url 'listar_notas' %}" class="btn-ver btn-limpar">Limpar</a>
            </div>
        </form>
    </div>

    <div class="resumo-bar">
        <div class="resumo-item dinheiro">
            <span>Dinheiro</span>
            <strong>R$ {{ totais.total_dinheiro|default:0|floatformat:2 }}</strong>
        </div>
        <div class="resumo-item pix">
            <span>PIX</span>
            <strong>R$ {{ totais.total_pix|default:0|floatformat:2 }}</strong>
        </div>
        <div class="resumo-item debito">
            <span>D√©bito</span>
            <strong>R$ {{ totais.total_debito|default:0|floatformat:2 }}</strong>
        </div>
        <div class="resumo-item credito">
            <span>Cr√©dito</span>
            <strong>R$ {{ totais.total_credito|default:0|floatformat:2 }}</strong>
        </div>
        <div class="resumo-item total">
            <span>TOTAL GERAL</span>
            <strong>R$ {{ totais.total_geral|default:0|floatformat:2 }}</strong>
        </div>
    </div>

    {% if notas %}
        <table>
            <thead>
                <tr>
                    <th>N√∫mero</th>
                    <th>Data</th>
                    <th>Cliente</th>
                    <th>Valor</th>
                    <th>Pagamento</th>
                    <th>Status</th>
                    <th>A√ß√£o</th>
                </tr>
            </thead>
            <tbody>
                {% for nota in notas %}
                <tr>
                    <td data-label="N√∫mero">
                        <strong>{{ nota.numero }}</strong>
                    </td>
                    
                    <td data-label="Data">{{ nota.data_emissao|date:"d/m/Y H:i" }}</td>
                    
                    <td data-label="Cliente">
                        {% if nota.cliente %}
                            {{ nota.cliente.apelido|default:nota.cliente.nome|truncatechars:20 }}
                        {% else %}
                            <span style="color: #999; font-style: italic;">Consumidor Final</span>
                        {% endif %}
                    </td>
                    
                    <td data-label="Valor" style="color: {{ empresa_ativa.cor_primaria|default:'#00838f' }}; font-weight: bold;">
                        R$ {{ nota.valor_total }}
                    </td>
                    
                    <td data-label="Pagamento">
                        {% if nota.forma_pagamento == '01' %}
                            <span style="background-color: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.85em; border: 1px solid #2e7d32;">DINHEIRO</span>
                        {% elif nota.forma_pagamento == '17' %}
                            <span style="background-color: #e3f2fd; color: #1565c0; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.85em; border: 1px solid #1565c0;">PIX</span>
                        {% elif nota.forma_pagamento == '04' %}
                            <span style="background-color: #fffde7; color: #fbc02d; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.85em; border: 1px solid #fbc02d;">D√âBITO</span>
                        {% elif nota.forma_pagamento == '03' %}
                            <span style="background-color: #ffebee; color: #c62828; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.85em; border: 1px solid #c62828;">CR√âDITO</span>
                        {% else %}
                            <span style="background-color: #f5f5f5; color: #616161; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.85em; border: 1px solid #616161;">{{ nota.get_forma_pagamento_display|upper|default:"N√ÉO INF." }}</span>
                        {% endif %}
                    </td>
                    
                    <td data-label="Status">
                        <span class="status {% if nota.status == 'CANCELADA' %}cancelada{% endif %}">{{ nota.status }}</span>
                    </td>
                    
                    <td data-label="A√ß√£o">
                        <a href="{% url 'imprimir_nota' nota.id %}" target="_blank" class="btn-ver">üìÑ PDF</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="empty-state">
            <h3>Nenhuma nota encontrada.</h3>
            <p>Tente ajustar os filtros acima.</p>
            <br>
            <a href="{% url 'listar_notas' %}" class="btn-ver">Ver Todas</a>
        </div>
    {% endif %}
</div>

<script>
    $(document).ready(function() {
        $('.select2-cliente').select2({
            placeholder: "Selecione clientes...",
            allowClear: true,
            width: '100%',
            language: { noResults: function() { return "Nenhum cliente encontrado"; } }
        });

        $('.select2-pagamento').select2({
            placeholder: "Formas de pgto...",
            allowClear: true,
            width: '100%'
        });
    });
</script>
{% endblock %}