{% extends 'base.html' %}

{% block title %}Frente de Caixa{% endblock %}

{% block head %}
    <style>
        /* Container principal */
        .container-pdv { 
            width: 100%; max-width: 600px; margin: 0 auto; background: white; 
            padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            display: flex; flex-direction: column; max-height: 95vh; 
        }
        
        h1 { text-align: center; color: #2c3e50; margin: 0 0 15px 0; font-size: 1.4rem; }

        /* Busca */
        .area-busca { position: relative; margin-bottom: 15px; flex-shrink: 0; }
        .input-busca { 
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; 
            font-size: 1.1em; box-sizing: border-box; -webkit-appearance: none; 
        }
        .input-busca:focus { border-color: #3498db; outline: none; }
        
        .sugestoes-lista { 
            position: absolute; top: 100%; left: 0; width: 100%; background: white; 
            border: 1px solid #ddd; z-index: 1000; max-height: 200px; overflow-y: auto; 
            display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-radius: 0 0 8px 8px;
        }
        .sugestao-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .sugestao-item:active { background: #f0f8ff; }

        /* Carrinho */
        .carrinho { 
            background: #f8f9fa; border: 1px dashed #ccc; border-radius: 8px; 
            padding: 10px; margin-bottom: 10px; 
            max-height: 250px; overflow-y: auto; flex-grow: 1; 
        }
        
        .item-carrinho { 
            display: flex; justify-content: space-between; align-items: center; 
            background: white; padding: 10px; margin-bottom: 6px; border-radius: 6px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); gap: 8px;
        }
        .item-info { flex: 1; font-size: 0.9em; line-height: 1.2; }
        .item-valor { font-weight: bold; color: #2c3e50; white-space: nowrap; font-size: 0.95em; }
        .btn-remover { 
            background: #ffebee; color: #c0392b; border: none; width: 30px; height: 30px; 
            border-radius: 50%; cursor: pointer; font-weight: bold; display: flex; 
            align-items: center; justify-content: center; font-size: 1.2em; flex-shrink: 0;
        }

        /* RodapÃ© Fixo */
        .secao-inferior { flex-shrink: 0; }
        .total-display { 
            text-align: right; font-size: 1.8em; font-weight: 800; color: #27ae60; 
            margin-bottom: 15px; border-top: 2px solid #f0f0f0; padding-top: 10px; 
        }
        .area-acoes { 
            display: flex; gap: 8px; align-items: center; background: #eee; 
            padding: 8px; border-radius: 8px; margin-bottom: 15px;
        }
        .input-valor { 
            flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 6px; 
            font-size: 1.1em; text-align: center; -webkit-appearance: none; 
        }
        .btn-completar { 
            flex: 2; background: #f39c12; color: white; border: none; padding: 12px; 
            border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1em; 
        }
        .btn-refazer {
            background: #3498db; color: white; border: none; padding: 12px;
            border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1.2em;
            width: 45px; display: flex; align-items: center; justify-content: center;
        }
        .btn-emitir { 
            width: 100%; background: #27ae60; color: white; padding: 15px; 
            font-size: 1.2em; font-weight: bold; border: none; border-radius: 8px; 
            cursor: pointer; box-shadow: 0 4px 0 #219150; 
        }
        .btn-emitir:active { transform: translateY(2px); box-shadow: 0 2px 0 #219150; }
        .btn-emitir:disabled { background: #bdc3c7; box-shadow: none; cursor: not-allowed; }
        .btn-limpar { 
            background: none; border: none; color: #95a5a6; cursor: pointer; 
            text-decoration: underline; margin-top: 10px; display: block; width: 100%; padding: 5px; 
        }

        /* --- MODAL DE QUANTIDADE --- */
        dialog { 
            border: none; border-radius: 12px; padding: 20px; width: 85%; max-width: 350px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center;
        }
        dialog::backdrop { background: rgba(0,0,0,0.6); }
        .modal-titulo { font-size: 1.2em; color: #333; margin-bottom: 10px; }
        .modal-prod-nome { font-weight: bold; color: #2980b9; margin-bottom: 20px; font-size: 1.1em; }
        .input-qtd { 
            width: 100px; padding: 10px; font-size: 1.5em; text-align: center; 
            border: 2px solid #3498db; border-radius: 8px; margin-bottom: 20px;
        }
        .modal-btn-area { display: flex; gap: 10px; justify-content: center; }
        .btn-cancelar { background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; }
        .btn-confirmar { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; }

        @media (max-width: 480px) {
            .container-pdv { padding: 10px; height: auto; min-height: 90vh; }
            .area-acoes { flex-wrap: wrap; }
            .input-valor { flex: 100%; margin-bottom: 5px; }
            .btn-completar { flex: 4; }
            .btn-refazer { flex: 1; }
            .total-display { font-size: 2em; text-align: center; }
        }

        .sucesso-msg { background: #d4edda; padding: 10px; border-radius: 8px; color: #155724; text-align: center; margin-top: 10px; border: 1px solid #c3e6cb; }
        .btn-pdf { display: block; background: #2c3e50; color: white; padding: 10px; margin-top: 8px; text-decoration: none; border-radius: 5px; font-weight: bold; }
    </style>
{% endblock %}

{% block content %}
<div class="container-pdv">
    <h1>Frente de Caixa</h1>

    <div class="area-busca">
        <input type="text" id="buscaInput" class="input-busca" placeholder="ðŸ” Buscar produto..." autocomplete="off">
        <div id="listaSugestoes" class="sugestoes-lista"></div>
    </div>

    <div class="carrinho" id="carrinhoVisual">
        <div style="text-align: center; color: #bbb; padding: 30px 0;">
            ðŸ›’ Seu carrinho estÃ¡ vazio
        </div>
    </div>

    <div class="secao-inferior">
        <div class="total-display" id="totalDisplay">R$ 0,00</div>

        <div class="area-acoes">
            <input type="number" id="valorAlvoInput" class="input-valor" placeholder="Meta (R$)" inputmode="decimal">
            <button class="btn-completar" onclick="completarValor()">âš¡ Completar</button>
            <button class="btn-refazer" onclick="refazerSimulacao()" title="Tentar outros produtos">ðŸ”„</button>
        </div>

        <button class="btn-emitir" id="btnEmitir" onclick="emitirNota()" disabled>EMITIR NOTA</button>
        <button class="btn-limpar" onclick="limparCarrinho()">Limpar Carrinho</button>
        
        <div id="status"></div>
    </div>

    <dialog id="modalQuantidade">
        <div class="modal-titulo">Quantas unidades?</div>
        <div id="nomeProdModal" class="modal-prod-nome">...</div>
        
        <input type="number" id="qtdInputModal" class="input-qtd" value="1" min="1" inputmode="numeric">
        
        <div class="modal-btn-area">
            <button class="btn-cancelar" onclick="fecharModalQtd()">Cancelar</button>
            <button class="btn-confirmar" onclick="confirmarAdicaoManual()">ADICIONAR</button>
        </div>
    </dialog>
    
    {% csrf_token %}
</div>
{% endblock %}

{% block scripts %}
<script>
    let carrinho = []; 
    let produtoSelecionadoTemp = null; // Guarda o produto enquanto escolhe qtd

    const buscaInput = document.getElementById('buscaInput');
    const listaSugestoes = document.getElementById('listaSugestoes');
    const modalQtd = document.getElementById('modalQuantidade');

    // --- LÃ“GICA DE BUSCA ---
    buscaInput.addEventListener('input', async (e) => {
        const termo = e.target.value;
        if (termo.length < 2) { listaSugestoes.style.display = 'none'; return; }

        const res = await fetch(`/api/produtos/?q=${termo}`);
        const produtos = await res.json();

        listaSugestoes.innerHTML = '';
        if (produtos.length > 0) {
            listaSugestoes.style.display = 'block';
            produtos.forEach(prod => {
                const div = document.createElement('div');
                div.className = 'sugestao-item';
                div.innerHTML = `
                    <div style="flex:1">
                        <div style="font-weight:bold">${prod.nome}</div>
                        <small style="color:#777">R$ ${prod.preco_unitario.toFixed(2)}</small>
                    </div>
                    <div style="font-weight:bold; color:#2980b9">+</div>
                `;
                // Ao clicar, abre o modal em vez de adicionar direto
                div.onclick = () => { abrirModalQtd(prod); };
                listaSugestoes.appendChild(div);
            });
        } else {
            listaSugestoes.style.display = 'none';
        }
    });

    document.addEventListener('click', (e) => {
        if (e.target !== buscaInput) listaSugestoes.style.display = 'none';
    });

    // --- LÃ“GICA DO MODAL DE QUANTIDADE ---
    function abrirModalQtd(prod) {
        produtoSelecionadoTemp = prod;
        document.getElementById('nomeProdModal').innerText = prod.nome;
        document.getElementById('qtdInputModal').value = 1; // Reseta para 1
        
        listaSugestoes.style.display = 'none'; // Esconde sugestÃµes
        modalQtd.showModal();
        
        // Foca no campo de quantidade para digitar direto
        setTimeout(() => document.getElementById('qtdInputModal').focus(), 100);
    }

    function fecharModalQtd() {
        modalQtd.close();
        produtoSelecionadoTemp = null;
        buscaInput.value = ''; // Limpa a busca
    }

    function confirmarAdicaoManual() {
        if (!produtoSelecionadoTemp) return;

        const qtd = parseInt(document.getElementById('qtdInputModal').value);
        if (isNaN(qtd) || qtd <= 0) {
            alert("Quantidade invÃ¡lida");
            return;
        }

        // Adiciona ao carrinho com a quantidade escolhida
        carrinho.push({
            id: produtoSelecionadoTemp.id,
            nome: produtoSelecionadoTemp.nome,
            preco_unitario: produtoSelecionadoTemp.preco_unitario,
            quantidade: qtd,
            valor_total: produtoSelecionadoTemp.preco_unitario * qtd,
            ncm: produtoSelecionadoTemp.ncm
        });

        atualizarCarrinho();
        fecharModalQtd();
    }

    // --- RESTANTE DA LÃ“GICA (SimulaÃ§Ã£o, EmissÃ£o) ---
    async function completarValor() {
        const valorAlvo = parseFloat(document.getElementById('valorAlvoInput').value);
        const totalAtual = calcularTotal();
        
        if (isNaN(valorAlvo) || valorAlvo <= totalAtual) {
            alert("A meta deve ser maior que o total atual."); return;
        }

        const falta = valorAlvo - totalAtual;
        const btn = document.querySelector('.btn-completar');
        const txtOriginal = btn.innerText;
        btn.innerText = "â³...";
        btn.disabled = true;

        try {
            const res = await fetch(`/api/produtos/?simular=true&valor=${falta}`);
            const data = await res.json();
            if (data.error) { alert(data.error); return; }
            data.itens.forEach(item => carrinho.push(item));
            atualizarCarrinho();
        } catch (e) {
            alert("Erro de conexÃ£o.");
        } finally {
            btn.innerText = txtOriginal;
            btn.disabled = false;
        }
    }

    async function refazerSimulacao() {
        const valorAlvo = parseFloat(document.getElementById('valorAlvoInput').value);
        if (isNaN(valorAlvo) || valorAlvo <= 0) { alert("Digite uma meta para refazer."); return; }
        carrinho = [];
        atualizarCarrinho();
        await completarValor();
    }

    function atualizarCarrinho() {
        const divCarrinho = document.getElementById('carrinhoVisual');
        const totalDisplay = document.getElementById('totalDisplay');
        const btnEmitir = document.getElementById('btnEmitir');

        if (carrinho.length === 0) {
            divCarrinho.innerHTML = '<div style="text-align: center; color: #bbb; padding: 30px 0;">ðŸ›’ Seu carrinho estÃ¡ vazio</div>';
            totalDisplay.innerText = "R$ 0,00";
            btnEmitir.disabled = true;
            btnEmitir.style.background = "#bdc3c7";
            return;
        }

        divCarrinho.innerHTML = '';
        let total = 0;

        carrinho.forEach((item, index) => {
            total += item.valor_total;
            divCarrinho.innerHTML += `
                <div class="item-carrinho">
                    <div class="item-info">
                        <strong>${item.quantidade}x</strong> ${item.nome}
                    </div>
                    <div class="item-valor">R$ ${item.valor_total.toFixed(2)}</div>
                    <button class="btn-remover" onclick="removerItem(${index})">Ã—</button>
                </div>
            `;
        });
        
        divCarrinho.scrollTop = divCarrinho.scrollHeight;
        totalDisplay.innerText = "R$ " + total.toFixed(2);
        btnEmitir.disabled = false;
        btnEmitir.style.background = "#27ae60";
    }

    function removerItem(index) {
        carrinho.splice(index, 1);
        atualizarCarrinho();
    }

    function limparCarrinho() {
        if(confirm("Limpar todo o carrinho?")) {
            carrinho = [];
            atualizarCarrinho();
        }
    }

    function calcularTotal() {
        return carrinho.reduce((acc, item) => acc + item.valor_total, 0);
    }

    async function emitirNota() {
        const btn = document.getElementById('btnEmitir');
        const statusDiv = document.getElementById('status');
        
        if (!confirm(`Confirmar emissÃ£o de R$ ${calcularTotal().toFixed(2)}?`)) return;

        btn.disabled = true; btn.innerText = "ðŸš€ Enviando...";

        try {
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const res = await fetch('/emitir-nota/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify({ itens: carrinho })
            });
            const data = await res.json();

            if (res.ok) {
                statusDiv.innerHTML = `
                    <div class="sucesso-msg">
                        <h3>âœ… Nota Autorizada!</h3>
                        <a href="/imprimir-nota/${data.id_nota}/" target="_blank" class="btn-pdf">
                            ðŸ“„ BAIXAR / IMPRIMIR PDF
                        </a>
                    </div>`;
                carrinho = [];
                atualizarCarrinho();
            } else {
                alert("Erro: " + data.mensagem);
            }
        } catch (e) {
            alert("Erro de comunicaÃ§Ã£o");
        } finally {
            btn.innerText = "EMITIR NOTA";
            if(carrinho.length > 0) btn.disabled = false;
        }
    }
</script>
{% endblock %}